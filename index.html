<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>磨豆机刻度转换器 | Grinder Setting Converter</title>

  <!-- SEO Meta -->
  <meta name="description" content="免费在线磨豆机刻度转换工具。Comandante C40 ↔ 1Zpresso K-Ultra ↔ Mahlkönig EK43 刻度互转，含冲煮推荐。">
  <meta name="keywords" content="磨豆机,刻度转换,C40,K-Ultra,EK43,咖啡,研磨度,Comandante,1Zpresso,Mahlkönig">
  <meta name="theme-color" content="#f5f0e8">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="磨豆机刻度转换器">
  <meta property="og:description" content="C40 ↔ K-Ultra ↔ EK43 刻度在线转换工具">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="磨豆机刻度转换器">

  <!-- Google Fonts: Noto Serif SC for headings -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@600;700&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>☕</text></svg>">
  <style>
    :root {
      --bg-color: #f5f0e8;
      --card-bg: #faf8f4;
      --text-primary: #2d2a26;
      --text-secondary: #8a8278;
      --accent-color: #6b7c5e;
      --border-color: #e5dfd5;
      --success-color: #c45c3c;
      --warning-color: #8a7440;
      --font-serif: "Noto Serif SC", "Songti SC", "SimSun", serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Helvetica Neue", Arial, sans-serif,
                   "Apple Color Emoji", "Segoe UI Emoji";
      background-color: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    /* Language Switcher */
    .lang-switcher {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 24px;
    }

    .lang-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .lang-btn:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .lang-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Card */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    /* Direction Selection */
    .direction-selectors {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .grinder-select {
      flex: 1;
      min-width: 140px;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .grinder-select:hover {
      border-color: var(--accent-color);
    }

    .grinder-select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      outline: none;
    }

    .direction-arrow {
      font-size: 20px;
      color: var(--accent-color);
      font-weight: 600;
      flex-shrink: 0;
    }

    /* Input */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .input-field {
      flex: 1;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* 动画效果 */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.02);
      }
    }

    #resultContent {
      animation: fadeIn 0.25s ease-out;
    }

    .result-value {
      transition: transform 0.15s ease;
    }

    .warning {
      transition: opacity 0.2s ease, max-height 0.2s ease;
    }

    .lang-btn:active,
    .direction-option:active {
      transform: scale(0.98);
    }

    /* 键盘焦点样式 */
    .lang-btn:focus-visible,
    .direction-option:focus-visible,
    .input-field:focus-visible {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    .input-unit {
      font-size: 14px;
      color: var(--text-secondary);
      min-width: 60px;
    }

    /* Result */
    .result-container {
      text-align: center;
      padding: 20px 0;
    }

    .result-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--success-color);
      line-height: 1.2;
    }

    .result-unit {
      font-size: 16px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .result-notation {
      font-size: 20px;
      color: var(--accent-color);
      margin-top: 8px;
      font-weight: 500;
    }

    .result-placeholder {
      color: var(--text-secondary);
      font-size: 16px;
      padding: 24px 0;
    }

    /* Brew Method */
    .brew-method {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: rgba(22, 163, 74, 0.08);
      border-radius: 8px;
      margin-top: 16px;
    }

    .brew-method-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .brew-method-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--success-color);
    }

    /* Warning */
    .warning {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: rgba(217, 119, 6, 0.1);
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
      color: var(--warning-color);
    }

    .warning.show {
      display: flex;
    }

    /* Info Section */
    .info-section {
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
      margin-top: 4px;
    }

    .info-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .info-list {
      list-style: none;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .info-list li {
      margin-bottom: 6px;
      padding-left: 16px;
      position: relative;
    }

    .info-list li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--accent-color);
    }

    .disclaimer {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 24px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    /* 深色模式 */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1714;
        --card-bg: #242019;
        --text-primary: #e8e0d4;
        --text-secondary: #9a9287;
        --accent-color: #8a9e7a;
        --border-color: #3a352e;
        --success-color: #d4735c;
        --warning-color: #b8a060;
      }

      .grinder-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239a9287' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      }

      .brew-method {
        background: rgba(138, 158, 122, 0.1);
      }

      .input-field {
        background: var(--card-bg);
        color: var(--text-primary);
      }

      .input-field::placeholder {
        color: var(--text-secondary);
      }
    }

    /* Responsive */
    @media (min-width: 640px) {
      body {
        padding: 40px 20px;
      }

      .header h1 {
        font-size: 28px;
      }

      .card {
        padding: 28px;
      }

      .direction-selectors {
        flex-wrap: nowrap;
      }

      .grinder-select {
        min-width: 160px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Language Switcher -->
    <div class="lang-switcher">
      <button class="lang-btn active" data-lang="zh">中文</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>

    <!-- Header -->
    <div class="header">
      <h1 id="title">磨豆机刻度转换器</h1>
      <p class="subtitle" id="subtitle">C40 ↔ K-Ultra ↔ EK43</p>
    </div>

    <!-- Direction Selection -->
    <div class="card">
      <div class="card-title" id="directionLabel">转换方向</div>
      <div class="direction-selectors">
        <select id="sourceSelect" class="grinder-select" aria-label="源设备">
          <option value="c40">Comandante C40</option>
          <option value="kUltra">1Zpresso K-Ultra</option>
          <option value="ek43">Mahlkönig EK43</option>
        </select>
        <span class="direction-arrow">→</span>
        <select id="targetSelect" class="grinder-select" aria-label="目标设备">
          <option value="c40">Comandante C40</option>
          <option value="kUltra" selected>1Zpresso K-Ultra</option>
          <option value="ek43">Mahlkönig EK43</option>
        </select>
      </div>
    </div>

    <!-- Input -->
    <div class="card">
      <div class="card-title" id="inputLabel">输入刻度</div>
      <div class="input-group">
        <div class="input-wrapper">
          <input type="number" class="input-field" id="inputValue" placeholder="20" min="0" step="1" aria-describedby="inputUnit" aria-label="刻度数值">
          <span class="input-unit" id="inputUnit">C40 clicks</span>
        </div>
      </div>
    </div>

    <!-- Result -->
    <div class="card">
      <div class="card-title" id="resultLabel">转换结果</div>
      <div class="result-container" role="region" aria-live="polite" aria-label="转换结果">
        <div id="resultPlaceholder" class="result-placeholder">输入刻度后自动计算</div>
        <div id="resultContent" style="display: none;">
          <div class="result-value" id="resultValue">75</div>
          <div class="result-unit" id="resultUnit">clicks</div>
          <div class="result-notation" id="resultNotation">(0.7.5)</div>
          <div class="brew-method">
            <span class="brew-method-label" id="recommendLabel">推荐冲煮方式：</span>
            <span class="brew-method-value" id="brewMethod">V60 / 手冲</span>
          </div>
        </div>
        <div class="warning" id="warning" role="alert" aria-live="assertive">
          <span id="warningText">刻度超出常用范围</span>
        </div>
      </div>
    </div>

    <!-- Info Section -->
    <div class="card">
      <div class="info-section" style="border-top: none; padding-top: 0; margin-top: 0;">
        <div class="info-title" id="notationExplain">K-Ultra 刻度格式说明</div>
        <ul class="info-list">
          <li id="notationDesc">格式为 X.Y.Z，其中 X=圈数, Y=数字(0-9), Z=小格(0-9)</li>
          <li id="notationExample">例如 0.7.5 = 第0圈第7个数字再加5小格 = 75格</li>
        </ul>
      </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer" id="disclaimer">
      转换基于官方资料与 Honest Coffee Guide 社区对照数据校准（核验日期：2026-02-16），请根据实际口感微调
    </div>
  </div>

  <script>
    // Grinder configurations
    const GRINDERS = {
      c40: { min: 0, max: 40, step: 1, decimals: 0 },
      kUltra: { min: 0, max: 150, step: 1, decimals: 0 },
      ek43: { min: 0, max: 16, step: 0.1, decimals: 1 }
    };

    // Calibrated anchor points (verified on 2026-02-16)
    const C40_TO_K_POINTS = [
      [0, 0], [7, 24], [10, 37], [13, 49], [14, 49], [15, 53],
      [19, 67], [20, 72.5], [24, 86], [25, 91.5], [26, 91.5], [33, 95.5], [40, 100]
    ];
    const K_TO_C40_POINTS = [
      [0, 0], [24, 7], [37, 10], [49, 13.5], [53, 15],
      [67, 19], [72.5, 20], [86, 24], [91.5, 25.5], [95.5, 33], [100, 40]
    ];
    const EK43_TO_K_POINTS = [
      [0, 24], [2.55, 37], [4.7, 48], [5.1, 50], [5.7, 53], [8.5, 67],
      [9.5, 72.5], [12.3, 86], [13.1, 91], [13.3, 92], [14.55, 95.5], [16, 100]
    ];
    const K_TO_EK43_POINTS = [
      [24, 0], [37, 2.55], [48, 4.7], [50, 5.1], [53, 5.7], [67, 8.5],
      [72.5, 9.5], [86, 12.3], [91, 13.1], [92, 13.3], [95.5, 14.55], [100, 16]
    ];

    // i18n
    const i18n = {
      zh: {
        title: "磨豆机刻度转换器",
        subtitle: "C40 ↔ K-Ultra ↔ EK43",
        directionLabel: "转换方向",
        inputLabel: "输入刻度",
        inputPlaceholder: "20",
        resultLabel: "转换结果",
        resultPlaceholder: "输入刻度后自动计算",
        recommendLabel: "推荐冲煮方式：",
        notationExplain: "K-Ultra 刻度格式说明",
        notationDesc: "格式为 X.Y.Z，其中 X=圈数, Y=数字(0-9), Z=小格(0-9)",
        notationExample: "例如 0.7.5 = 第0圈第7个数字再加5小格 = 75格",
        disclaimer: "转换基于官方资料与 Honest Coffee Guide 社区对照数据校准（核验日期：2026-02-16），请根据实际口感微调",
        outOfRange: "刻度超出常用范围",
        sameGrinder: "请选择不同的磨豆机",
        grinders: {
          c40: "Comandante C40",
          kUltra: "1Zpresso K-Ultra",
          ek43: "Mahlkönig EK43"
        },
        units: {
          c40: "C40 clicks",
          kUltra: "K-Ultra clicks",
          ek43: "EK43 刻度"
        },
        brewMethods: {
          espresso: "意式浓缩",
          mokaPot: "摩卡壶",
          aeropressConc: "爱乐压（浓缩风格）",
          pourOver: "V60 / 手冲",
          aeropressLight: "爱乐压（清淡风格）",
          frenchPress: "法压壶",
          coldBrew: "冷萃"
        }
      },
      en: {
        title: "Grinder Setting Converter",
        subtitle: "C40 ↔ K-Ultra ↔ EK43",
        directionLabel: "Conversion Direction",
        inputLabel: "Input Setting",
        inputPlaceholder: "20",
        resultLabel: "Conversion Result",
        resultPlaceholder: "Enter a value to convert",
        recommendLabel: "Recommended: ",
        notationExplain: "K-Ultra Notation Explained",
        notationDesc: "Format: X.Y.Z where X=rotation, Y=number(0-9), Z=tick(0-9)",
        notationExample: "e.g. 0.7.5 = rotation 0, number 7, tick 5 = 75 clicks",
        disclaimer: "Calibrated with official references and Honest Coffee Guide mapping data (verified on 2026-02-16). Fine-tune according to taste.",
        outOfRange: "Setting out of typical range",
        sameGrinder: "Please select different grinders",
        grinders: {
          c40: "Comandante C40",
          kUltra: "1Zpresso K-Ultra",
          ek43: "Mahlkönig EK43"
        },
        units: {
          c40: "C40 clicks",
          kUltra: "K-Ultra clicks",
          ek43: "EK43 setting"
        },
        brewMethods: {
          espresso: "Espresso",
          mokaPot: "Moka Pot",
          aeropressConc: "AeroPress (concentrated)",
          pourOver: "V60 / Pour Over",
          aeropressLight: "AeroPress (lighter)",
          frenchPress: "French Press",
          coldBrew: "Cold Brew"
        }
      }
    };

    // State
    let currentLang = 'zh';
    let sourceGrinder = 'c40';
    let targetGrinder = 'kUltra';

    // DOM Elements
    const elements = {
      title: document.getElementById('title'),
      subtitle: document.getElementById('subtitle'),
      directionLabel: document.getElementById('directionLabel'),
      sourceSelect: document.getElementById('sourceSelect'),
      targetSelect: document.getElementById('targetSelect'),
      inputLabel: document.getElementById('inputLabel'),
      inputValue: document.getElementById('inputValue'),
      inputUnit: document.getElementById('inputUnit'),
      resultLabel: document.getElementById('resultLabel'),
      resultPlaceholder: document.getElementById('resultPlaceholder'),
      resultContent: document.getElementById('resultContent'),
      resultValue: document.getElementById('resultValue'),
      resultUnit: document.getElementById('resultUnit'),
      resultNotation: document.getElementById('resultNotation'),
      recommendLabel: document.getElementById('recommendLabel'),
      brewMethod: document.getElementById('brewMethod'),
      warning: document.getElementById('warning'),
      warningText: document.getElementById('warningText'),
      notationExplain: document.getElementById('notationExplain'),
      notationDesc: document.getElementById('notationDesc'),
      notationExample: document.getElementById('notationExample'),
      disclaimer: document.getElementById('disclaimer')
    };

    // Conversion functions
    function interpolatePiecewise(value, points) {
      if (!Array.isArray(points) || points.length < 2) return value;

      if (value <= points[0][0]) {
        const [x0, y0] = points[0];
        const [x1, y1] = points[1];
        return y0 + ((value - x0) * (y1 - y0)) / (x1 - x0);
      }

      for (let i = 1; i < points.length; i++) {
        const [x0, y0] = points[i - 1];
        const [x1, y1] = points[i];
        if (value <= x1) {
          if (x1 === x0) return y1;
          return y0 + ((value - x0) * (y1 - y0)) / (x1 - x0);
        }
      }

      const [x0, y0] = points[points.length - 2];
      const [x1, y1] = points[points.length - 1];
      return y1 + ((value - x1) * (y1 - y0)) / (x1 - x0);
    }

    function clampToGrinderRange(value, grinderKey) {
      const config = GRINDERS[grinderKey];
      if (!config) return value;
      return Math.min(config.max, Math.max(config.min, value));
    }

    // Convert any grinder to K-Ultra (intermediate value)
    function toKUltra(value, source) {
      switch (source) {
        case 'c40': return interpolatePiecewise(value, C40_TO_K_POINTS);
        case 'kUltra': return value;
        case 'ek43': return interpolatePiecewise(value, EK43_TO_K_POINTS);
        default: return value;
      }
    }

    // Convert K-Ultra to any grinder
    function fromKUltra(kUltraValue, target) {
      switch (target) {
        case 'c40': return interpolatePiecewise(kUltraValue, K_TO_C40_POINTS);
        case 'kUltra': return kUltraValue;
        case 'ek43': return interpolatePiecewise(kUltraValue, K_TO_EK43_POINTS);
        default: return kUltraValue;
      }
    }

    // Main conversion: source → K-Ultra → target
    function convertValue(value, source, target) {
      if (source === target) return clampToGrinderRange(value, target);
      const kUltraValue = toKUltra(value, source);
      const converted = fromKUltra(kUltraValue, target);
      return clampToGrinderRange(converted, target);
    }

    // Format result based on target grinder
    function formatResult(value, target) {
      const config = GRINDERS[target];
      return Number(value.toFixed(config.decimals));
    }

    function clicksToNotation(clicks) {
      const rotation = Math.floor(clicks / 100);
      const remaining = clicks % 100;
      const number = Math.floor(remaining / 10);
      const tick = remaining % 10;
      return `${rotation}.${number}.${tick}`;
    }

    // Brew method by K-Ultra (used as reference for all grinders)
    function getBrewMethodByKUltra(clicks, lang) {
      const methods = i18n[lang].brewMethods;
      if (clicks < 30) return methods.espresso;
      if (clicks < 45) return methods.mokaPot;
      if (clicks < 70) return methods.aeropressConc;
      if (clicks < 95) return methods.pourOver;
      if (clicks < 110) return methods.aeropressLight;
      if (clicks < 130) return methods.frenchPress;
      return methods.coldBrew;
    }

    // Brew method by C40
    function getBrewMethodByC40(clicks, lang) {
      const methods = i18n[lang].brewMethods;
      if (clicks < 8) return methods.espresso;
      if (clicks < 12) return methods.mokaPot;
      if (clicks < 18) return methods.aeropressConc;
      if (clicks < 25) return methods.pourOver;
      if (clicks < 30) return methods.aeropressLight;
      if (clicks < 35) return methods.frenchPress;
      return methods.coldBrew;
    }

    // Brew method by EK43
    function getBrewMethodByEK43(setting, lang) {
      const methods = i18n[lang].brewMethods;
      if (setting < 1) return methods.espresso;
      if (setting < 3) return methods.mokaPot;
      if (setting < 6) return methods.aeropressConc;
      if (setting < 9) return methods.pourOver;
      if (setting < 11) return methods.aeropressLight;
      if (setting < 13) return methods.frenchPress;
      return methods.coldBrew;
    }

    // Get brew method based on grinder type
    function getBrewMethod(value, grinder, lang) {
      switch (grinder) {
        case 'c40': return getBrewMethodByC40(value, lang);
        case 'kUltra': return getBrewMethodByKUltra(value, lang);
        case 'ek43': return getBrewMethodByEK43(value, lang);
        default: return '';
      }
    }

    // Update UI texts
    function updateTexts() {
      const t = i18n[currentLang];
      elements.title.textContent = t.title;
      elements.subtitle.textContent = t.subtitle;
      elements.directionLabel.textContent = t.directionLabel;
      elements.inputLabel.textContent = t.inputLabel;
      elements.inputValue.placeholder = t.inputPlaceholder;
      elements.resultLabel.textContent = t.resultLabel;
      elements.resultPlaceholder.textContent = t.resultPlaceholder;
      elements.recommendLabel.textContent = t.recommendLabel;
      elements.notationExplain.textContent = t.notationExplain;
      elements.notationDesc.textContent = t.notationDesc;
      elements.notationExample.textContent = t.notationExample;
      elements.disclaimer.textContent = t.disclaimer;

      // Update input unit based on source grinder
      elements.inputUnit.textContent = t.units[sourceGrinder];

      // Update result unit based on target grinder
      elements.resultUnit.textContent = t.units[targetGrinder];
    }

    // Update input field attributes based on source grinder
    function updateInputConfig() {
      const config = GRINDERS[sourceGrinder];
      elements.inputValue.min = config.min;
      elements.inputValue.max = config.max;
      elements.inputValue.step = config.step;
    }

    // Convert and display result
    function convert() {
      const t = i18n[currentLang];
      const input = parseFloat(elements.inputValue.value);

      // Check if same grinder selected
      if (sourceGrinder === targetGrinder) {
        elements.resultPlaceholder.style.display = 'block';
        elements.resultPlaceholder.textContent = t.sameGrinder;
        elements.resultContent.style.display = 'none';
        elements.warning.classList.remove('show');
        return;
      }

      if (isNaN(input) || elements.inputValue.value === '') {
        elements.resultPlaceholder.style.display = 'block';
        elements.resultPlaceholder.textContent = t.resultPlaceholder;
        elements.resultContent.style.display = 'none';
        elements.warning.classList.remove('show');
        return;
      }

      const sourceConfig = GRINDERS[sourceGrinder];
      const targetConfig = GRINDERS[targetGrinder];
      let isOutOfRange = false;

      // Check if input is out of range
      if (input < sourceConfig.min || input > sourceConfig.max) {
        isOutOfRange = true;
      }

      // Perform conversion
      const rawResult = convertValue(input, sourceGrinder, targetGrinder);
      const result = formatResult(rawResult, targetGrinder);

      // Show result
      elements.resultPlaceholder.style.display = 'none';
      elements.resultContent.style.display = 'block';
      elements.resultValue.textContent = result;
      elements.resultUnit.textContent = t.units[targetGrinder];

      // Show notation for K-Ultra output
      if (targetGrinder === 'kUltra') {
        elements.resultNotation.style.display = 'block';
        elements.resultNotation.textContent = `(${clicksToNotation(Math.round(result))})`;
      } else {
        elements.resultNotation.style.display = 'none';
      }

      // Get brew method based on target grinder
      elements.brewMethod.textContent = getBrewMethod(result, targetGrinder, currentLang);

      // Warning
      if (isOutOfRange) {
        elements.warning.classList.add('show');
        elements.warningText.textContent = t.outOfRange;
      } else {
        elements.warning.classList.remove('show');
      }
    }

    // Event Listeners
    // Language switcher
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentLang = btn.dataset.lang;
        document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
        updateTexts();
        convert();
      });
    });

    // Source grinder select
    elements.sourceSelect.addEventListener('change', () => {
      sourceGrinder = elements.sourceSelect.value;
      const t = i18n[currentLang];
      elements.inputUnit.textContent = t.units[sourceGrinder];
      updateInputConfig();
      elements.inputValue.value = '';
      convert();
    });

    // Target grinder select
    elements.targetSelect.addEventListener('change', () => {
      targetGrinder = elements.targetSelect.value;
      convert();
    });

    // Input field
    elements.inputValue.addEventListener('input', convert);

    // Initialize
    updateTexts();
    updateInputConfig();
  </script>
</body>
</html>
